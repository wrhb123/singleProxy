# Single-Port WebSocket Proxy

ä¸€ä¸ªé«˜æ•ˆã€ç¨³å®šã€åŠŸèƒ½ä¸°å¯Œçš„å†…ç½‘ç©¿é€å·¥å…·ï¼ŒåŸºäºŽ WebSocket å®žçŽ°ã€‚å®ƒå…è®¸æ‚¨é€šè¿‡å•ä¸ªå…¬ç½‘ç«¯å£ï¼Œå°†å¤šä¸ªå†…ç½‘æœåŠ¡æš´éœ²åˆ°äº’è”ç½‘ä¸Šã€‚

## âœ¨ ç‰¹æ€§

- ðŸš€ **å•ç«¯å£å¤ç”¨**ï¼šå…¬ç½‘æœåŠ¡å™¨åªéœ€å¼€æ”¾ä¸€ä¸ªç«¯å£å³å¯ä»£ç†æ‰€æœ‰æœåŠ¡
- ðŸ”„ **åè®®è½¬æ¢**ï¼šåœ¨ HTTP(S) å’Œ WebSocket ä¹‹é—´è¿›è¡Œæ— ç¼è½¬æ¢
- ðŸ”’ **TLS æ”¯æŒ**ï¼šæ”¯æŒä½¿ç”¨ HTTPS/WSS è¿›è¡ŒåŠ å¯†ä¼ è¾“ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨
- ðŸ”‘ **å¯†é’¥éš”ç¦»**ï¼šä½¿ç”¨ä¸åŒçš„å¯†é’¥æ¥åŒºåˆ†å’Œè·¯ç”±åˆ°ä¸åŒçš„å†…ç½‘æœåŠ¡
- ðŸ’“ **å¿ƒè·³ä¿æ´»**ï¼šè‡ªåŠ¨ç»´æŠ¤è¿žæŽ¥çŠ¶æ€ï¼Œé˜²æ­¢å› ç½‘ç»œç©ºé—²è€Œæ–­å¼€
- ðŸ”„ **è‡ªåŠ¨é‡è¿ž**ï¼šå®¢æˆ·ç«¯åœ¨ç½‘ç»œä¸­æ–­åŽèƒ½å¤Ÿè‡ªåŠ¨é‡æ–°è¿žæŽ¥ï¼Œç¡®ä¿æœåŠ¡é«˜å¯ç”¨
- ðŸ“¦ **æµå¼ä¼ è¾“**ï¼šæ”¯æŒå¤§æ–‡ä»¶å’Œå¤§æ•°æ®é‡çš„å“åº”ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼Œæ€§èƒ½ä¼˜å¼‚

## ðŸ—ï¸ å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

è¯¥ä»£ç†ç”±ä¸€ä¸ª Serverï¼ˆæœåŠ¡å™¨ç«¯ï¼‰å’Œä¸€ä¸ªæˆ–å¤šä¸ª Clientï¼ˆå®¢æˆ·ç«¯ï¼‰ç»„æˆã€‚

1. Server éƒ¨ç½²åœ¨å…·æœ‰å…¬ç½‘ IP çš„æœåŠ¡å™¨ä¸Šï¼Œç›‘å¬ä¸€ä¸ªç«¯å£ï¼ˆä¾‹å¦‚ 443ï¼‰
2. Client éƒ¨ç½²åœ¨æ‚¨çš„å†…ç½‘æœºå™¨ä¸Šï¼Œå¹¶ä¸»åŠ¨ä¸Ž Server å»ºç«‹ä¸€ä¸ªæŒä¹…çš„ WebSocket éš§é“
3. å½“å…¬ç½‘ç”¨æˆ·è®¿é—® Server æ—¶ï¼ŒServer æ ¹æ®è¯·æ±‚å¤´ä¸­çš„å¯†é’¥ï¼Œå°†è¯·æ±‚é€šè¿‡å¯¹åº”çš„ WebSocket éš§é“è½¬å‘ç»™æŒ‡å®šçš„ Client
4. Client æ”¶åˆ°è¯·æ±‚åŽï¼Œå°†å…¶è½¬å‘åˆ°æœ¬åœ°çš„ç›®æ ‡æœåŠ¡ï¼Œå¹¶å°†å“åº”åŽŸè·¯è¿”å›ž

```
Public User  --->  [Public Server]  --->  [WebSocket Tunnel]  --->  [Internal Client]  --->  [Target Service]
               (HTTP/S)              (WebSocket)             (HTTP/S)
Public User  <---  [Public Server]  <---  [WebSocket Tunnel]  <---  [Internal Client]  <---  [Target Service]
```

## ðŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶

- Go 1.19 æˆ–æ›´é«˜ç‰ˆæœ¬

### æž„å»º

ä»Žæºä»£ç æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š

```bash
go build -o singleproxy
```

### 1. è¿è¡ŒæœåŠ¡ç«¯

åœ¨æ‚¨çš„å…¬ç½‘æœåŠ¡å™¨ä¸Šï¼Œå¯åŠ¨ server æ¨¡å¼ã€‚

#### ä½¿ç”¨ HTTPS (æŽ¨è)

```bash
./singleproxy -mode=server -port=443 -cert=/path/to/your/cert.pem -key-file=/path/to/your/key.pem
```

#### ä½¿ç”¨ HTTP (ä»…ç”¨äºŽæµ‹è¯•)

```bash
./singleproxy -mode=server -port=8080
```

### 2. è¿è¡Œå®¢æˆ·ç«¯

åœ¨æ‚¨çš„å†…ç½‘æœºå™¨ä¸Šï¼Œå¯åŠ¨ client æ¨¡å¼ï¼Œå°†å…¶è¿žæŽ¥åˆ°å…¬ç½‘æœåŠ¡å™¨ï¼Œå¹¶æŒ‡å®šè¦ä»£ç†çš„ç›®æ ‡æœåŠ¡ã€‚

```bash
./singleproxy \
  -mode=client \
  -server="wss://your-proxy-domain.com" \
  -target="127.0.0.1:8080" \
  -key="my-secret-service-key"
```

- `-server`: æ‚¨çš„å…¬ç½‘æœåŠ¡å™¨åœ°å€ï¼Œä½¿ç”¨ ws:// æˆ– wss://
- `-target`: æ‚¨å†…ç½‘æœåŠ¡çš„åœ°å€ï¼Œä¾‹å¦‚ 127.0.0.1:80
- `-key`: ä¸€ä¸ªè‡ªå®šä¹‰çš„å¯†é’¥ï¼Œç”¨äºŽåœ¨æœåŠ¡å™¨ä¸Šè¯†åˆ«æ­¤æœåŠ¡

### 3. è®¿é—®æ‚¨çš„å†…ç½‘æœåŠ¡

çŽ°åœ¨ï¼Œæ‚¨å¯ä»¥ä»Žäº’è”ç½‘ä¸Šçš„ä»»ä½•åœ°æ–¹è®¿é—®æ‚¨çš„å†…ç½‘æœåŠ¡äº†ã€‚

```bash
curl -H "X-Tunnel-Key: my-secret-service-key" https://your-proxy-domain.com/some/path
```

## ðŸ“‹ å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | é€‚ç”¨æ¨¡å¼ | æè¿° | é»˜è®¤å€¼ |
|------|----------|------|--------|
| `-mode` | All | è¿è¡Œæ¨¡å¼ï¼Œserver æˆ– client | `server` |
| `-port` | Server | æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£ | `443` |
| `-cert` | Server | TLS è¯ä¹¦æ–‡ä»¶è·¯å¾„ (ç”¨äºŽ HTTPS) | - |
| `-key-file` | Server | TLS ç§é’¥æ–‡ä»¶è·¯å¾„ (ç”¨äºŽ HTTPS) | - |
| `-server` | Client | æœåŠ¡å™¨åœ°å€ (å®¢æˆ·ç«¯è¿žæŽ¥ç”¨) | - |
| `-target` | Client | å†…ç½‘ç›®æ ‡æœåŠ¡çš„åœ°å€ | - |
| `-key` | Client | ç”¨äºŽè¯†åˆ«æœåŠ¡çš„éš§é“å¯†é’¥ | `default` |
| `-insecure` | Client | è·³è¿‡å¯¹æœåŠ¡å™¨ TLS è¯ä¹¦çš„éªŒè¯ (ä¸å®‰å…¨ï¼Œä»…ç”¨äºŽæµ‹è¯•) | `false` |

## ðŸ’¡ ç¤ºä¾‹ï¼šæš´éœ²ä¸€ä¸ªæœ¬åœ° Web æœåŠ¡

å‡è®¾æ‚¨çš„å†…ç½‘æœºå™¨ä¸Šè¿è¡Œç€ä¸€ä¸ªåœ¨ 8080 ç«¯å£çš„ Web åº”ç”¨ã€‚

### ä½¿ç”¨ Python å¿«é€Ÿå¯åŠ¨ä¸€ä¸ªç®€å•çš„ Web æœåŠ¡å™¨

1. å¯åŠ¨ Python Web æœåŠ¡å™¨

```bash
python3 -m http.server 8080
```

2. å¯åŠ¨ä»£ç†å®¢æˆ·ç«¯ (åœ¨å†…ç½‘æœºå™¨ä¸Š)

```bash
./singleproxy -mode=client -server="wss://proxy.example.com" -target="127.0.0.1:8080" -key="local-web"
```

3. ä»Žå…¬ç½‘è®¿é—®

```bash
curl -H "X-Tunnel-Key: local-web" https://proxy.example.com/
```

æ‚¨å°†çœ‹åˆ°ç”± Python Web æœåŠ¡å™¨è¿”å›žçš„ç›®å½•åˆ—è¡¨ã€‚

## ðŸ“ TODO

- [ ] TCP éš§é“: æ‰©å±•åè®®ä»¥æ”¯æŒä»»æ„ TCP æµé‡ï¼Œä»Žè€Œå¯ä»¥ä»£ç† SSHã€æ•°æ®åº“ç­‰æœåŠ¡
- [ ] åŠ å¯†ï¼šç«¯åˆ°ç«¯åŠ å¯†ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
- [ ] é€ŸçŽ‡é™åˆ¶: åœ¨æœåŠ¡å™¨ç«¯å®žçŽ°é€ŸçŽ‡é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨

## ðŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ðŸ¤ è´¡çŒ®

æ¬¢è¿Žæäº¤ Issue å’Œ Pull Requestï¼

## ðŸ“ž æ”¯æŒ

å¦‚æžœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ Issue è”ç³»æˆ‘ä»¬ã€‚