# 模拟防火墙+路径转发场景的Nginx配置

server {
    listen 443 ssl;
    server_name test.example.com;

    # 自签名证书（测试用）
    ssl_certificate /etc/nginx/ssl/test.crt;
    ssl_certificate_key /etc/nginx/ssl/test.key;

    # 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE+AESGCM:ECDHE+AES256:ECDHE+AES128:!aNULL:!MD5:!DSS;
    ssl_prefer_server_ciphers on;

    # 日志配置
    access_log /var/log/nginx/proxy_access.log;
    error_log /var/log/nginx/proxy_error.log;

    # ==========================================
    # 正向代理路径 - 模拟防火墙只允许特定路径
    # ==========================================
    location /tunnel/proxy/ {
        # 转发到Single Proxy服务器的HTTP代理功能
        proxy_pass http://127.0.0.1:8000/proxy/;
        proxy_http_version 1.1;

        # 保持连接
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 支持长连接和大文件传输
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;

        # 添加调试头
        add_header X-Nginx-Route "tunnel-proxy" always;
    }

    # ==========================================
    # 内网穿透路径 - 模拟防火墙只允许特定路径
    # ==========================================
    location /tunnel/app/ {
        # 转发到Single Proxy服务器的内网穿透功能
        # 去掉/tunnel/app前缀，保留后面的路径
        rewrite ^/tunnel/app/(.*)$ /$1 break;

        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 保持原始头部
        proxy_pass_request_headers on;

        # 添加调试头
        add_header X-Nginx-Route "tunnel-app" always;
    }

    # ==========================================
    # HTTP长轮询隧道路径（不支持WebSocket时的替代方案）
    # ==========================================
    location /tunnel/http-tunnel/ {
        # 转发到Single Proxy服务器的HTTP长轮询功能
        proxy_pass http://127.0.0.1:8000/http-tunnel/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 支持长轮询的特殊配置
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 60s;  # 长轮询超时时间
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;

        # 添加调试头
        add_header X-Nginx-Route "tunnel-http-polling" always;
    }

    # ==========================================
    # WebSocket隧道注册路径
    # ==========================================
    location /tunnel/ws/ {
        # WebSocket升级支持
        proxy_pass http://127.0.0.1:8000/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # WebSocket特定配置
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        add_header X-Nginx-Route "tunnel-ws" always;
    }

    # ==========================================
    # 拒绝其他所有路径（模拟严格的防火墙）
    # ==========================================
    location / {
        add_header X-Nginx-Route "blocked" always;
        return 403 "Access denied: Only tunnel paths are allowed";
    }

    # 健康检查端点
    location /health {
        add_header Content-Type text/plain;
        return 200 "Nginx Proxy OK";
    }
}

# HTTP重定向到HTTPS（模拟生产环境）
server {
    listen 80;
    server_name test.example.com;
    return 301 https://$server_name$request_uri;
}